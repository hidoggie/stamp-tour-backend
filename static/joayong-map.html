<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤íƒ¬í”„ íˆ¬ì–´ - í–‰ì„± ì—¬í–‰</title>
    <style>
        /* CSSëŠ” ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€í•©ë‹ˆë‹¤. */
        html, body, #map { height: 100%; margin: 0; padding: 0; font-family: sans-serif; }
        #modal, #status-modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; align-items: center; justify-content: center; }
        .modal-content { background-color: #edefe8; margin: auto; padding: 20px; border-radius: 10px; width: 80%; max-width: 400px; text-align: center; }
        .modal-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .modal-buttons button { padding: 10px 20px; font-size: 1em; cursor: pointer; border-radius: 5px; border: none; color: white; }
        .btn-stamp { background-color: #007bff; }
        .btn-photo { background-color: #28a745; }
        .gm-style-iw-c button {
            display: none !important;
        }
        .gm-style-iw-d {
            padding: 10px !important;
        }

        #map {
          position: absolute;
          width: 100%;
          height: 92%;
          top: 8%;
          z-index: 9999;
        }

        .container {
          width: 100%;
          height: 95vh;
          background-size: contain;
          display: flex;
          justify-content: center;
          align-items: center;
        }
        #section {
          display: none;
        }
        #info {
          position: absolute;
          top: 0;
          width: 100%;
          height: 8%;  
          text-align: center;
          background-color: #e8e8e8;
        }
        
        @import url("https://fonts.googleapis.com/css2?family=Edu+AU+VIC+WA+NT+Hand:wght@400..700&display=swap");

        @font-face {
            font-family: "Pretendard-Regular";
            src: url("https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff")
                format("woff");
            font-weight: 400;
            font-style: normal;
        }

        @font-face {
            font-family: "HSSanTokki20-Regular";
            src: url("https://fastly.jsdelivr.net/gh/projectnoonnu/2405@1.0/HSSanTokki20-Regular.woff2")
                format("woff2");
            font-weight: normal;
            font-style: normal;
        }


        .font-Pretendard-Regular {
            font-family: "Pretendard-Regular";
        }

    </style>
</head>
<body>
    <div class="container">
    <div id="info" class="font-Pretendard-Regular">
     <section id="section">
       <label id="text"> </label> 
      </section>  
      <h3 class="font-Pretendard-Regular" style="color:#9C6B5D;">ì¡°ì•„ìš©ì„ ì°¾ì•„ë¼!
    </div>
      
    <div id="map"></div>
    
    <div id="modal">
        <div class="modal-content">
            <h2 id="modal-title"></h2>
            <p>ìŠ¤íƒ¬í”„ ì¡´ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤! ë¬´ì—‡ì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="modal-buttons">
                <button id="modal-stamp-btn" class="btn-stamp">ìŠ¤íƒ¬í”„ íˆ¬ì–´ ì°¸ì—¬</button>
                <button id="modal-photo-btn" class="btn-photo">AR í¬í† ì¡´ ê°€ê¸°</button>
            </div>
        </div>
    </div>

    <div id="status-modal" class="modal">
        <div class="modal-content">
            <h2 id="status-modal-title"></h2>
            <p id="status-modal-text"></p>
            <div class="modal-buttons">
                <button id="status-modal-btn" style="background-color: darkgray;"></button>
                <button id="status-modal-close-btn" style="background-color: #6c757d;">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        let map; // ì „ì—­ ë³€ìˆ˜ë¡œ map ê°ì²´ ì„ ì–¸
        let userMarker = null;
        let activeModalId = null;
        let proximityCheckInterval = null;
        let hasShownOutOfBoundsAlert = false;
        const proximityModal = document.getElementById('modal');

        const eventCenterPoint = { lat: 37.4895, lng: 126.9556 }; // ì´ë²¤íŠ¸ ì¤‘ì‹¬ ì¢Œí‘œ
        const eventRadius = 500; // ì´ë²¤íŠ¸ ì°¸ì—¬ ê°€ëŠ¥ ë°˜ê²½ (300ë¯¸í„°)

            const stampLocations1 = [
                { title: 'â˜€ï¸ íƒœì–‘', lat: 37.465467, lng: 126.387857, id: 'sun' },
                { title: 'ğŸ’§ ìˆ˜ì„±', lat: 37.465789, lng: 126.386757, id: 'mercury' },
                { title: 'âœ¨ ê¸ˆì„±', lat: 37.466490, lng: 126.388020, id: 'venus' },
                { title: 'ğŸŒ í† ì„±', lat: 37.465762, lng: 126.385614, id: 'saturn' },
                { title: 'ğŸ”´ í™”ì„±', lat: 37.467071, lng: 126.386995, id: 'mars' },
                { title: 'ğŸª ëª©ì„±', lat: 37.466879, lng: 126.386567, id: 'jupiter' },
            ];

            const stampLocations = [
                { title: 'â˜€ï¸ íƒœì–‘', lat: 37.489121, lng: 126.955418, id: 'sun' },
                { title: 'ğŸ’§ ìˆ˜ì„±', lat: 37.4895,   lng: 126.9556, id: 'mercury' },
                { title: 'âœ¨ ê¸ˆì„±', lat: 37.4893,   lng: 126.9561, id: 'venus' },
                { title: 'ğŸŒ í† ì„±', lat: 37.488928, lng: 126.956250, id: 'saturn' },
                { title: 'ğŸ”´ í™”ì„±', lat: 37.4891, lng: 126.9569, id: 'mars' },
                { title: 'ğŸª ëª©ì„±', lat: 37.4892, lng: 126.9551, id: 'jupiter' },
            ];

        const TOTAL_STAMPS = stampLocations.length;

        const statusModal = document.getElementById('status-modal');
        const statusModalText = document.getElementById('status-modal-text');
        const statusModalBtn = document.getElementById('status-modal-btn');
        const statusModalCloseBtn = document.getElementById('status-modal-close-btn');

        // 2. Google Maps APIê°€ ë¡œë“œëœ í›„ 'initMap' í•¨ìˆ˜ê°€ ìë™ìœ¼ë¡œ í˜¸ì¶œë©ë‹ˆë‹¤.
        function initMap() {
                // âœ¨ ì‚¬ìš©ì ID í™•ì¸ ë° ìƒì„± ë¡œì§ (ê°€ì¥ ë¨¼ì € ì‹¤í–‰)
            let userId = localStorage.getItem('userId');
            if (!userId) {
               // crypto.randomUUID()ëŠ” ë§¤ìš° ì•ˆì „í•˜ê³  ê³ ìœ í•œ IDë¥¼ ìƒì„±í•˜ëŠ” ìµœì‹  í‘œì¤€ ë°©ì‹ì…ë‹ˆë‹¤.
                userId = crypto.randomUUID();
                localStorage.setItem('userId', userId);
                console.log(`ìƒˆë¡œìš´ ì‚¬ìš©ì IDê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: ${userId}`);
            } else {
                console.log(`ê¸°ì¡´ ì‚¬ìš©ì IDë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤: ${userId}`);
            }

            map = new google.maps.Map(document.getElementById('map'), {
                center: eventCenterPoint,
                zoom: 18,
            });

            // ì‚¬ìš©ìì˜ ìµœì¢… ìƒíƒœë¥¼ ë¨¼ì € í™•ì¸
            checkUserStatusOnLoad();

            // ìŠ¤íƒ¬í”„ ì¡´ ë§ˆì»¤ í‘œì‹œ
            displayStampMarkers();

            google.maps.event.addListenerOnce(map, 'tilesloaded', () => {
                console.log("ì§€ë„ ë¡œë”© ì™„ë£Œ. ìœ„ì¹˜ ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤.");
        
                updateUserLocation();
                setInterval(updateUserLocation, 5000);
            });           
        }

    window.addEventListener('pageshow', (event) => {
        // event.persistedê°€ trueì´ë©´, í˜ì´ì§€ê°€ ìºì‹œ(bfcache)ì—ì„œ ë¡œë“œëœ ê²ƒì…ë‹ˆë‹¤.
        // ì–´ë–¤ ê²½ìš°ë“ , í˜ì´ì§€ê°€ ë‹¤ì‹œ ë³´ì´ë©´ íŒì—…ì„ ë‹«ìŠµë‹ˆë‹¤.
        console.log("í˜ì´ì§€ê°€ ë‹¤ì‹œ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤. ì—´ë ¤ìˆëŠ” íŒì—…ì°½ì„ ë‹«ìŠµë‹ˆë‹¤.");
        
        if (proximityModal) {
            proximityModal.style.display = 'none';
        }
        activeModalId = null;
    });


        function checkUserStatusOnLoad() {
            const userId = localStorage.getItem('userId');
            if (!userId) return; // ì‚¬ìš©ì IDê°€ ì—†ìœ¼ë©´ í™•ì¸í•˜ì§€ ì•ŠìŒ

            const collectedStamps = JSON.parse(localStorage.getItem('stamps')) || {};

            // ìŠ¤íƒ¬í”„ë¥¼ ëª¨ë‘ ëª¨ì•˜ì„ ê²½ìš°ì—ë§Œ ì„œë²„ì— í™•ì¸
            if (Object.keys(collectedStamps).length >= TOTAL_STAMPS) {
                fetch(`/api/check-eligibility/${userId}`)
                    .then(res => res.json())
                    .then(status => {
                        if (status.hasRedeemed) {
                            // ê²½í’ˆê¹Œì§€ ëª¨ë‘ ìˆ˜ë ¹í•œ ê²½ìš°
                            showStatusModal(
                                "ì°¸ì—¬ ì™„ë£Œ",
                                "ëª¨ë“  ì´ë²¤íŠ¸ì— ì°¸ì—¬í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! ê²½í’ˆì„ ì´ë¯¸ ìˆ˜ë ¹í•˜ì…¨ìŠµë‹ˆë‹¤.",
                                "í™•ì¸"
                            );
                        } else {
                            // ìŠ¤íƒ¬í”„ëŠ” ë‹¤ ëª¨ì•˜ì§€ë§Œ ì•„ì§ ê²½í’ˆì„ ë°›ì§€ ì•Šì€ ê²½ìš°
                            showStatusModal(
                                "ìŠ¤íƒ¬í”„ ì™„ì„±!",
                                "ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  ìŠ¤íƒ¬í”„ë¥¼ ëª¨ì•˜ìŠµë‹ˆë‹¤. ì§€ê¸ˆ ê²½í’ˆì„ ë°›ìœ¼ëŸ¬ ê°€ì‹œê² ìŠµë‹ˆê¹Œ?",
                                "ğŸ QRì½”ë“œ ì°ê¸°",
                                () => { window.location.href = 'scanner.html'; }
                            );
                        }
                    });
            }
        }

        // âœ¨ 3. ë§ˆì»¤ë¥¼ ìƒì„±í•˜ëŠ” ë¡œì§ì„ ë³„ë„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬
        function displayStampMarkers() {
            const collectedStamps = JSON.parse(localStorage.getItem('stamps')) || {};
            stampLocations.forEach(loc => {
                let markerIconUrl = null;
                if (collectedStamps[loc.id]) {
                    markerIconUrl = 'http://maps.google.com/mapfiles/ms/icons/green-dot.png';
                }
                const marker = new google.maps.Marker({
                    position: { lat: loc.lat, lng: loc.lng },
                    map: map,
                    icon: markerIconUrl,
                });
                const infoWindow = new google.maps.InfoWindow({ content: `<div>${loc.title}</div>` });
                marker.addListener("mouseover", () => infoWindow.open(map, marker));
                marker.addListener("mouseout", () => infoWindow.close());
            });
        }

        // âœ¨ 3. ìƒíƒœ íŒì—…ì°½ì„ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜
        function showStatusModal(title, text, buttonText, buttonAction = null) {
            document.getElementById('status-modal-title').textContent = title;
            statusModalText.textContent = text;
            statusModalBtn.textContent = buttonText;
            
            if (buttonAction) {
                statusModalBtn.style.display = 'inline-block';
                statusModalBtn.onclick = buttonAction;
            } else {
                statusModalBtn.style.display = 'none'; // ë²„íŠ¼ì´ í•„ìš” ì—†ëŠ” ê²½ìš° ìˆ¨ê¹€
            }
        
            statusModal.style.display = 'flex';
            statusModal.style.zindex = '99999';
        }

        statusModalCloseBtn.onclick = () => {
            statusModal.style.display = 'none';
        };

        function updateUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const userPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };
                    if (!map) return; // mapì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ

                    const userLatLng = new google.maps.LatLng(userPosition.lat, userPosition.lng);
                    const eventCenterLatLng = new google.maps.LatLng(eventCenterPoint.lat, eventCenterPoint.lng);

          // âœ¨âœ¨âœ¨ ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ ì¶”ê°€ âœ¨âœ¨âœ¨
            console.clear(); // ì´ì „ ë¡œê·¸ë¥¼ ì§€ì›Œ ê¹”ë”í•˜ê²Œ ë³´ì´ë„ë¡ í•¨
            console.log("--- ìœ„ì¹˜ ì •ë³´ ë””ë²„ê¹… ---");
            console.log("ì‚¬ìš©ì ìœ„ì¹˜ (ì…ë ¥ê°’):", userPosition);
            console.log("í–‰ì‚¬ì¥ ì¤‘ì‹¬ (ì…ë ¥ê°’):", eventCenterPoint);

                    const distance = google.maps.geometry.spherical.computeDistanceBetween(userLatLng, eventCenterLatLng);

           console.log("ê³„ì‚°ëœ ê±°ë¦¬ (ë¯¸í„° ë‹¨ìœ„):", distance);
           console.log("-----------------------");                    

                    if (distance > eventRadius) {
                        // âœ¨ 3. ê±°ë¦¬ê°€ 300ë¯¸í„°ë³´ë‹¤ ë©€ ê²½ìš°
                        if (!hasShownOutOfBoundsAlert) {
                            alert("ì´ë²¤íŠ¸ ì¥ì†Œì—ì„œ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤. í–‰ì‚¬ì¥ìœ¼ë¡œ ì´ë™í•˜ì—¬ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                        // âœ¨ 2. ì•Œë¦¼ì„ í•œë²ˆ ë³´ì—¬ì¤¬ë‹¤ê³  ìƒíƒœë¥¼ ê¸°ë¡í•©ë‹ˆë‹¤.
                            hasShownOutOfBoundsAlert = true;
                        }
                        // ë‚´ ìœ„ì¹˜ ë§ˆì»¤ê°€ ìˆë‹¤ë©´ ìˆ¨ê¹ë‹ˆë‹¤.
                        if (userMarker) {
                            userMarker.setMap(null); 
                        }
                        return; // ìŠ¤íƒ¬í”„ ê·¼ì ‘ í™•ì¸ ë¡œì§ì„ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
                    }

                    hasShownOutOfBoundsAlert = false;

                    if (userMarker) {
                        userMarker.setPosition(userPosition);
                        if (userMarker.getMap() === null) {
                        userMarker.setMap(map); // ìˆ¨ê²¨ì ¸ ìˆì—ˆë‹¤ë©´ ë‹¤ì‹œ í‘œì‹œ
                        }
                    } else {
                        userMarker = new google.maps.Marker({
                            position: userPosition,
                            map: map,
                            title: "ë‚´ ìœ„ì¹˜",
                            icon: {
                                url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                            }
                        });
                    }    
   //                 map.setCenter(userPosition);
                    checkProximity(userPosition);
                }, () => { alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); });
            }
        }

        function checkProximity(userLatLng) {

            if(activeModalId) return; // ëª¨ë‹¬ì´ ì´ë¯¸ ë– ìˆìœ¼ë©´ ì¶”ê°€ í™•ì¸ ì•ˆí•¨

            const proximityLimit = 30; // 20ë¯¸í„°
//            const from = new google.maps.LatLng(userPos.lat, userPos.lng);
            
            for (const loc of stampLocations) {
                const to = new google.maps.LatLng(loc.lat, loc.lng);
                // 'geometry' ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì´ìš©í•œ ê±°ë¦¬ ê³„ì‚°
//               const distance = google.maps.geometry.spherical.computeDistanceBetween(from, to);
                const distance = google.maps.geometry.spherical.computeDistanceBetween(userLatLng, to);
                if (distance <= proximityLimit) {
    // ì‹¤í–‰ì‹œ í™œì„±í™”                const collectedStamps = JSON.parse(localStorage.getItem('stamps')) || {};
    // ì‹¤í–‰ì‹œ í™œì„±í™”                if (!collectedStamps[loc.id]) {
                        showProximityModal(loc.title, loc.id);
                        break;
    // ì‹¤í–‰ì‹œ í™œì„±í™”                }
                } 
            }
        }

    //    let activeModalId = null;

        function showProximityModal(title, id) {
            if(activeModalId === id) return;
            activeModalId = id;

            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');

            modalTitle.textContent = title;
            modal.style.display = 'flex';

            document.getElementById('modal-stamp-btn').onclick = () => { window.location.href = `stamptour.html?planet=${id}`; };
            document.getElementById('modal-photo-btn').onclick = () => { window.location.href = `photozone.html?planet=${id}`; };
       
        }

        window.onclick = (event) => {
            const modal = document.getElementById('modal');
            if (event.target == modal) {
                modal.style.display = "none";
                activeModalId = null;
            }
        }

    </script>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDD1yVqHohmfS5DnULxMJhFtN325JLnvpo&libraries=geometry&callback=initMap"></script>
</body>

</html>
