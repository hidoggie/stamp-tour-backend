<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스탬프 투어</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; text-align: center; background-color: #1a1a2e; color: white; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .hidden { display: none; }
        #video-player { width: 100%; max-width: 640px; border-radius: 10px; margin-bottom: 20px; }
        
        /* 퀴즈 섹션 */
        #quiz-container { background-color: #162447; padding: 20px; border-radius: 10px; }
        #question { font-size: 1.5em; margin-bottom: 20px; }
        .options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .options button { padding: 15px; font-size: 1.1em; cursor: pointer; border: 2px solid #0f3460; background-color: #1f4068; color: white; border-radius: 8px; transition: background-color 0.3s; }
        .options button:hover { background-color: #e43f5a; }
        
        /* 스탬프 카드 섹션 */
        #stamp-card-container { margin-top: 30px; }
        .stamp-card { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; background-color: #e43f5a; padding: 15px; border-radius: 10px; }
        .stamp-slot { background-color: rgba(255,255,255,0.2); border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; position: relative; }
        .stamp-slot img { max-width: 90%; max-height: 90%; opacity: 0.3; }
        .stamp-slot.stamped img { opacity: 1; transform: scale(1.1); transition: transform 0.5s; }
        .planet-name { font-size: 0.7em; margin-top: 65px; position: absolute; }
        
        /* 결과 및 네비게이션 */
        #result-container { margin-top: 20px; }
        .nav-buttons button { padding: 12px 25px; font-size: 1.1em; cursor: pointer; border-radius: 5px; border: none; color: white; margin: 0 10px; }
        .btn-map { background-color: #0f3460; }
        .btn-photo { background-color: #1f4068; }
    </style>
</head>
<body>

<div class="container">
    <h1 id="planet-title">행성 탐사</h1>

    <div id="video-container">
        <video id="video-player" playsinline autoplay muted oncontextmenu="return false;"></video>
        <p>행성 소개 영상을 시청 후 퀴즈에 참여하세요!</p>
    </div>

    <div id="quiz-container" class="hidden">
        <h2 id="question"></h2>
        <div id="options" class="options"></div>
    </div>
    
    <div id="stamp-card-container">
        <h2>🚀 행성 탐사 스탬프 카드</h2>
        <div id="stamp-card" class="stamp-card"></div>
    </div>
    
    <div id="result-container" class="hidden">
        <p id="result-message" style="font-size: 1.2em;"></p>
        <div class="nav-buttons">
            <button id="map-btn" class="btn-map">🗺️ 메인 지도로</button>
            <button id="photo-btn" class="btn-photo">📸 AR 포토존으로</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- 1. 행성 데이터 및 퀴즈 풀 ---
    const planetData1 = {
        sun: { name: '☀️ 태양', video: './mp4/sun.mp4', stamp: './images/sun.png', quizPool: [
            { q: "태양의 표면 온도는 약 몇 도일까요?", o: ["1천도", "6천도", "1만도", "10만도"], a: 1 },
            { q: "태양계 전체 질량의 몇 %를 태양이 차지할까요?", o: ["50.8%", "70.8%", "90.8%", "99.8%"], a: 3 },
            // ... (3 more questions)
        ]},
        mercury: { name: '💧 수성', video: '/mp4/mercury.mp4', stamp: '/images/mercury.png', quizPool: [
            { q: "수성의 영어 이름은 무엇일까요?", o: ["Mars", "Venus", "Mercury", "Jupiter"], a: 2 },
            // ... (4 more questions)
        ]},
        venus: { name: '✨ 금성', video: '/mp4/venus.mp4', stamp: '/images/venus.png', quizPool: [
            { q: "태양의 표면 온도는 약 몇 도일까요?", o: ["1천도", "6천도", "1만도", "10만도"], a: 1 },
            { q: "태양계 전체 질량의 몇 %를 태양이 차지할까요?", o: ["50.8%", "70.8%", "90.8%", "99.8%"], a: 3 },
            // ... (3 more questions)
        ]},
        earth: { name: '🌍 지구', video: '/mp4/earth.mp4', stamp: '/images/earth.png', quizPool: [
            { q: "태양의 표면 온도는 약 몇 도일까요?", o: ["1천도", "6천도", "1만도", "10만도"], a: 1 },
            { q: "태양계 전체 질량의 몇 %를 태양이 차지할까요?", o: ["50.8%", "70.8%", "90.8%", "99.8%"], a: 3 },
            // ... (3 more questions)
        ]},  
        moon: { name: '🌕 달', video: '/mp4/moon.mp4', stamp: '/images/moon.png', quizPool: [
            { q: "태양의 표면 온도는 약 몇 도일까요?", o: ["1천도", "6천도", "1만도", "10만도"], a: 1 },
            { q: "태양계 전체 질량의 몇 %를 태양이 차지할까요?", o: ["50.8%", "70.8%", "90.8%", "99.8%"], a: 3 },
            // ... (3 more questions)
        ]},
        mars: { name: '🔴 화성', video: '/mp4/mars.mp4', stamp: '/images/mars.png', quizPool: [
            { q: "태양의 표면 온도는 약 몇 도일까요?", o: ["1천도", "6천도", "1만도", "10만도"], a: 1 },
            { q: "태양계 전체 질량의 몇 %를 태양이 차지할까요?", o: ["50.8%", "70.8%", "90.8%", "99.8%"], a: 3 },
            // ... (3 more questions)
        ]},    
        jupiter: { name: '🪐 목성', video: '/mp4/jupiter.mp4', stamp: '/images/jupiter.png', quizPool: [
            { q: "태양의 표면 온도는 약 몇 도일까요?", o: ["1천도", "6천도", "1만도", "10만도"], a: 1 },
            { q: "태양계 전체 질량의 몇 %를 태양이 차지할까요?", o: ["50.8%", "70.8%", "90.8%", "99.8%"], a: 3 },
            // ... (3 more questions)
        ]},    
        saturn: { name: '💫 토성', video: '/mp4/saturn.mp4', stamp: '/images/saturn.png', quizPool: [
            { q: "태양의 표면 온도는 약 몇 도일까요?", o: ["1천도", "6천도", "1만도", "10만도"], a: 1 },
            { q: "태양계 전체 질량의 몇 %를 태양이 차지할까요?", o: ["50.8%", "70.8%", "90.8%", "99.8%"], a: 3 },
            // ... (3 more questions)
        ]}, 
        uranus: { name: '💎 천왕성', video: '/mp4/uranus.mp4', stamp: '/images/uranus.png', quizPool: [
            { q: "태양의 표면 온도는 약 몇 도일까요?", o: ["1천도", "6천도", "1만도", "10만도"], a: 1 },
            { q: "태양계 전체 질량의 몇 %를 태양이 차지할까요?", o: ["50.8%", "70.8%", "90.8%", "99.8%"], a: 3 },
            // ... (3 more questions)
        ]},                              
        neptune: { name: '🌊 해왕성', video: '/mp4/neptune.mp4', stamp: '/images/neptune.png', quizPool: [
            { q: "태양의 표면 온도는 약 몇 도일까요?", o: ["1천도", "6천도", "1만도", "10만도"], a: 1 },
            { q: "태양계 전체 질량의 몇 %를 태양이 차지할까요?", o: ["50.8%", "70.8%", "90.8%", "99.8%"], a: 3 },
            // ... (3 more questions)
        ]},                              

    };

    // test용
        const planetData = {
        sun: { name: '☀️ 태양', video: './mp4/sun.mp4', stamp: './images/sun.png', quizPool: [
            { q: "태양의 표면 온도는 약 몇 도일까요?", o: ["1천도", "6천도", "1만도", "10만도"], a: 1 },
            { q: "태양계 전체 질량의 몇 %를 태양이 차지할까요?", o: ["50.8%", "70.8%", "90.8%", "99.8%"], a: 3 },
            // ... (3 more questions)
        ]},
        mercury: { name: '💧 수성', video: './mp4/mercury.mp4', stamp: './images/mercury.png', quizPool: [
            { q: "수성의 영어 이름은 무엇일까요?", o: ["Mars", "Venus", "Mercury", "Jupiter"], a: 3 },
            // ... (4 more questions)
        ]},
        venus: { name: '✨ 금성', video: './mp4/venus.mp4', stamp: './images/venus.png', quizPool: [
            { q: "태양의 표면 온도는 약 몇 도일까요?", o: ["1천도", "6천도", "1만도", "10만도"], a: 1 },
            { q: "태양계 전체 질량의 몇 %를 태양이 차지할까요?", o: ["50.8%", "70.8%", "90.8%", "99.8%"], a: 3 },
            // ... (3 more questions)
        ]},
        earth: { name: '🌍 지구', video: './mp4/earth.mp4', stamp: './images/earth.png', quizPool: [
            { q: "태양의 표면 온도는 약 몇 도일까요?", o: ["1천도", "6천도", "1만도", "10만도"], a: 1 },
            { q: "태양계 전체 질량의 몇 %를 태양이 차지할까요?", o: ["50.8%", "70.8%", "90.8%", "99.8%"], a: 3 },
            // ... (3 more questions)
        ]},  
    };

    // --- 2. 요소 가져오기 ---
    const planetTitle = document.getElementById('planet-title');
    const videoContainer = document.getElementById('video-container');
    const videoPlayer = document.getElementById('video-player');
    const quizContainer = document.getElementById('quiz-container');
    const questionEl = document.getElementById('question');
    const optionsEl = document.getElementById('options');
    const stampCardEl = document.getElementById('stamp-card');
    const resultContainer = document.getElementById('result-container');
    const resultMessage = document.getElementById('result-message');
    const mapBtn = document.getElementById('map-btn');
    const photoBtn = document.getElementById('photo-btn');
    
    let currentPlanetId;
    let currentQuiz;

    // --- 3. 페이지 초기화 ---
    function initPage() {
        const urlParams = new URLSearchParams(window.location.search);
        currentPlanetId = urlParams.get('planet');        
        const currentPlanet = planetData[currentPlanetId];
        const PlanetCount = Object.keys(planetData).length;

        if (!currentPlanet) {
            alert("잘못된 접근입니다.");
            window.location.href = './joayong-map.html';
            return;
        }

        planetTitle.textContent = `${currentPlanet.name} 탐사`;
        
        // 스탬프 카드 렌더링
        renderStampCard();
        
        // 이미 획득한 스탬프인지 확인
        const collectedStamps = JSON.parse(localStorage.getItem('stamps')) || {};
        const userId = localStorage.getItem('userId');  

        if (Object.keys(collectedStamps).length >= PlanetCount) {
        // ✨ 1. 가장 먼저 전체 스탬프 개수부터 확인합니다.
    
        fetch(`/api/check-eligibility/${userId}`)
            .then(res => res.json())
            .then(status => {
                console.log("서버 응답 (경품 수령 여부):", status.hasRedeemed);
                console.log("현재 로컬 스탬프 개수:", Object.keys(collectedStamps).length);

            if (status.hasRedeemed) {
                // 1. 최종 경품까지 받은 유저
                videoContainer.classList.add('hidden');
                quizContainer.classList.add('hidden');
                resultMessage.textContent = "모든 이벤트에 참여해주셔서 감사합니다! 경품을 이미 수령하셨습니다.";
                mapBtn.textContent = "🗺️ 메인 지도로";
                mapBtn.onclick = () => { window.location.href = './joayong-map.html'; };
                photoBtn.classList.add('hidden');
                resultContainer.classList.remove('hidden');
                return; // 여기서 로직 종료
            } 
            
            if (Object.keys(collectedStamps).length >= PlanetCount) {
                // 2. 스탬프는 다 모았지만 아직 QR을 안 찍은 유저
                videoContainer.classList.add('hidden');
                quizContainer.classList.add('hidden');                
                resultMessage.textContent = "축하합니다! 모든 스탬프를 모았습니다. 부스에서 QR코드를 찍어 경품을 받으세요!";
                mapBtn.textContent = "🎁 QR코드 찍기";
                mapBtn.onclick = () => { window.location.href = './scanner.html'; };
                photoBtn.classList.add('hidden');
                resultContainer.classList.remove('hidden'); 
                return; // 여기서 로직 종료
            } 
            
            if (collectedStamps[currentPlanetId]) {
                // 3. 현재 스탬프만 이미 획득한 유저
                videoContainer.classList.add('hidden');
                quizContainer.classList.add('hidden');
                resultMessage.textContent = "이미 이 행성의 스탬프를 획득했습니다!";
                resultContainer.classList.remove('hidden'); 
                return; // 여기서 로직 종료
            } 
            
            // 4. 새로운 스탬프에 도전하는 유저
            videoContainer.classList.remove('hidden');
            resultContainer.classList.add('hidden');
            videoPlayer.src = currentPlanet.video;
            videoPlayer.onended = showQuiz;
            
        })
    
        .catch(err => {
            console.error("자격 확인 API 호출 오류:", err);
            alert("사용자 정보를 확인하는 중 오류가 발생했습니다.");
        });
    }

}

    // --- 4. 퀴즈 표시 ---
    function showQuiz() {
        videoContainer.classList.add('hidden');
        quizContainer.classList.remove('hidden');
        
        const currentPlanet = planetData[currentPlanetId];
        // 5문제 중 랜덤으로 하나 선택
        currentQuiz = currentPlanet.quizPool[Math.floor(Math.random() * currentPlanet.quizPool.length)];
        
        questionEl.textContent = currentQuiz.q;
        optionsEl.innerHTML = '';
        currentQuiz.o.forEach((optionText, index) => {
            const button = document.createElement('button');
            button.textContent = optionText;
            button.onclick = () => checkAnswer(index + 1);
            optionsEl.appendChild(button);
        });
    }

    // --- 5. 정답 확인 및 스탬프 획득 ---
    function checkAnswer(selectedIndex) {
        if (selectedIndex === currentQuiz.a) {
            const collectedStamps = JSON.parse(localStorage.getItem('stamps')) || {};
            collectedStamps[currentPlanetId] = true;
            localStorage.setItem('stamps', JSON.stringify(collectedStamps));
            
            resultMessage.textContent = "정답입니다! ✨ 스탬프를 획득했습니다!";
            initPage();
//           renderStampCard(); // 스탬프 카드 UI 업데이트

            // 10개 모두 모았는지 확인
//            if (Object.keys(collectedStamps).length >= 10) {
            const PlaneLength = Object.keys(planetData).length;
            if (Object.keys(collectedStamps).length >= PlaneLength) {
                // 10개를 모두 모았다면, "QR코드 찍기" 버튼 표시
                resultMessage.innerHTML += "<br>축하합니다! 모든 스탬프를 모았습니다. 부스에서 QR코드를 찍어 경품을 받으세요!";
                mapBtn.textContent = "🎁 QR코드 찍기";
                mapBtn.onclick = () => { window.location.href = 'scanner.html'; };
                photoBtn.classList.add('hidden');
            }
            // 10개가 안되면 기존 버튼 유지
            quizContainer.classList.add('hidden');
            resultContainer.classList.remove('hidden');

        } else {
            resultMessage.textContent = "아쉬워요, 정답이 아닙니다. 다시 도전해보세요!";
            quizContainer.classList.add('hidden');
            resultContainer.classList.remove('hidden');
            // 오답 시에는 2초 후 다시 퀴즈 화면으로
            setTimeout(() => {
                resultContainer.classList.add('hidden');
                showQuiz();
            }, 2000);
        }
    }
    
    // --- 6. 스탬프 카드 렌더링 ---
    function renderStampCard() {
        stampCardEl.innerHTML = '';
        const collectedStamps = JSON.parse(localStorage.getItem('stamps')) || {};

        Object.keys(planetData).forEach(planetId => {
            const planet = planetData[planetId];
            const slot = document.createElement('div');
            slot.className = 'stamp-slot';
            
            const img = document.createElement('img');
            img.src = planet.stamp;

            const name = document.createElement('div');
            name.className = 'planet-name';
            name.textContent = planet.name.split(' ')[1]; // 이모지 제외하고 이름만 표시

            if (collectedStamps[planetId]) {
                slot.classList.add('stamped');
            }
            
            slot.appendChild(img);
            slot.appendChild(name);
            stampCardEl.appendChild(slot);
        });
    }

    // --- 7. 네비게이션 버튼 ---
    mapBtn.onclick = () => { window.location.href = './joayong-map.html'; };
    photoBtn.onclick = () => { window.location.href = `photozone.html?planet=${currentPlanetId}`; };

    // --- 페이지 로드 시 시작 ---
    initPage();
});
</script>

</body>
</html>