<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />

    <title>AR ì¡°ì•¼ìš©ì„ ì°¾ì•„ë¼</title>
      <!-- Pretendard Font -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />

    <script src="./js/aframe150.js"></script>
    <script src="./js/aframe-ar.js"></script>
    <script src="./js/aframe-extras.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* ë¶ˆí•„ìš”í•œ ìŠ¤í¬ë¡¤ë°” ë°©ì§€ */
        }

        a-scene {
            width: 100%;
            height: 100%;
        }

        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif;
               text-align: center; background-color: #111827; color: white; margin: 0;  font-size: 14px; line-height: 1.5;}
        .container { max-width: 448px; margin: 0 auto; padding: 16px; min-height: 100vh; }
        .hidden { display: none; }
        #video-player { width: 100%; max-width: 640px; border-radius: 10px; margin-bottom: 20px; }
        
        /* í€´ì¦ˆ ì„¹ì…˜ */
        #quiz-container { background-color: #1f2937; padding: 16px; border-radius: 12px; border: 1px solid #4b5563; margin-bottom: 16px; backdrop-filter: blur(8px);} 
        #question { font-size: 1.5em; margin-bottom: 20px; }
        .options { display: grid; grid-template-columns: 1fr; }
        .options button { padding: 15px; font-size: 1.1em; cursor: pointer; border: 2px solid #4b5563;; background-color: #1f4068; color: white; border-radius: 8px; transition: background-color 0.3s; }
        .options button:hover { background-color: #e43f5a; }
        
        /* ìŠ¤íƒ¬í”„ ì¹´ë“œ ì„¹ì…˜ */
        #stamp-card-container { margin-top: 30px; }
        .stamp-card { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; background-color: #e43f5a; padding: 15px; border-radius: 10px; }
        .stamp-slot { background-color: rgba(255,255,255,0.2); border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; position: relative; }
        .stamp-slot img { max-width: 90%; max-height: 90%; opacity: 0.3; }
        .stamp-slot.stamped img { opacity: 1; transform: scale(1.1); transition: transform 0.5s; }
        .planet-name { font-size: 0.7em; margin-top: 65px; position: absolute; }
        
        /* ê²°ê³¼ ë° ë„¤ë¹„ê²Œì´ì…˜ */
        #result-container { margin-top: 20px; }
        .nav-buttons button { padding: 12px 25px; font-size: 1.1em; cursor: pointer; border-radius: 5px; border: none; color: white; margin: 0 10px; }
        .btn-map { background-color: #0f3460; }
        .btn-photo { background-color: #1f4068; }

        #ar-view, #video-quiz-view { width: 100%; height: 100%; }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">

<div class="container">
    <h1 id="planet-title">í–‰ì„± íƒì‚¬</h1>
    <p style="font-size: 18px; color: #e5e7eb;">í€´ì¦ˆë¥¼ í’€ê³  ìŠ¤íƒ¬í”„ë¥¼ ëª¨ì•„ë³´ì„¸ìš”</p>

    <!--div id="video-quiz-view" class="hidden">
    </div-->


    <!--div id="video-container" class="hidden">
        <video id="video-player" playsinline autoplay muted oncontextmenu="return false;"></video>
        <p>í–‰ì„± ì†Œê°œ ì˜ìƒì„ ì‹œì²­ í›„ í€´ì¦ˆì— ì°¸ì—¬í•˜ì„¸ìš”!</p>
    </div-->

    <div id="quiz-container" class="hidden">
        <div id="Planet-Info"></div>
        <h2 id="question"></h2>
        <div id="options" class="options"></div>
    </div>
    
    <div id="stamp-card-container" class="hidden">
        <h2>ğŸš€ í–‰ì„± íƒì‚¬ ìŠ¤íƒ¬í”„ ì¹´ë“œ</h2>
        <div id="stamp-card" class="stamp-card"></div>
    </div>
    
    <div id="result-container" class="hidden">
        <p id="result-message" style="font-size: 1.2em;"></p>
        <div class="nav-buttons">
            <button id="map-btn" class="btn-map">ğŸ—ºï¸ ë©”ì¸ ì§€ë„ë¡œ</button>
            <button id="photo-btn" class="btn-photo">ğŸ“¸ AR í¬í† ì¡´ìœ¼ë¡œ</button>
        </div>
    </div>
</div>
    <div id="ar-view">
        <a-scene
            id="scene"
            vr-mode-ui="enabled: false"
            arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
            renderer="logarithmicDepthBuffer: true"
            emitevents="true" 
            cursor="rayOrigin: mouse"
            raycaster="objects: .clickable"
        >

            <a-entity
                id="planet-model"
                position="1 2 -4"
                rotation="20 -30 0"
                animation-mixer>
            </a-entity>
            <a-entity
                id="joayong-model"
                position="-0.5 1 -4"
                rotation="20 -30 0"
                animation-mixer>
            </a-entity>
            
            <a-entity movement-controls="fly: true">
            <a-entity camera position="0 1.6 0" look-controls></a-entity>
            <a-light type="ambient" intensity="2"></a-light>
        </a-scene>

        <div id="info" style="position: fixed; top: 85vh; text-align: center; width: 100%; color: white; z-index:10; background: rgba(0,0,0,0.5); padding: 10px;">
             ì£¼ë³€ì„ ë‘˜ëŸ¬ë³´ê³  ì¡°ì•„ìš©ì„ í„°ì¹˜í•˜ì„¸ìš”!
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const sceneEl = document.querySelector('a-scene');
    const arView = document.getElementById('ar-view');
//    const videoQuizView = document.getElementById('video-quiz-view');
    const planetModel = document.getElementById('planet-model');
    const joayongModel = document.getElementById('joayong-model');
    const InfoView = document.getElementById('info');

    const joayongPos = {
        sun:     { name: 'íƒœì–‘', lat: 37.489121, lng: 126.955418, model: './models/joayong_rocket.glb', scale: '0.5 0.5 0.5' }, 
        mercury: { name: 'ìˆ˜ì„±', lat: 37.4895, lng: 126.9556, model: './models/joayong_rocket.glb', scale: '0.5 0.5 0.5' },
        venus:   { name: 'ê¸ˆì„±', lat: 37.4893,   lng: 126.9561, model: './models/joayong_rocket.glb', scale: '0.5 0.5 0.5' },
        saturn:  { name: 'í† ì„±', lat: 37.488928, lng: 126.956250, model: './models/joayong_rocket.glb', scale: '0.5 0.5 0.5' },
        mars:   { name: 'í™”ì„±', lat: 37.4891, lng: 126.9569, model: './models/joayong_rocket.glb', scale: '0.5 0.5 0.5' },
        jupiter:   { name: 'ëª©ì„±', lat: 37.488615, lng: 126.956499, model: './models/joayong_rocket.glb', scale: '0.5 0.5 0.5' },        
    };    

    const planetPos = {
        earth:     { name: 'ì§€êµ¬', lat: 37.489121, lng: 126.955418, model: './models/saturn_planet.glb', scale: '0.4 0.4 0.4' }, 
        mars: { name: 'í™”ì„±', lat: 37.4895, lng: 126.9556, model: './models/saturn_planet.glb', scale: '0.4 0.4 0.4' },
        jupiter:   { name: 'ëª©ì„±', lat: 37.4893,   lng: 126.9561, model: './models/saturn_planet.glb', scale: '0.4 0.4 0.4' },
        saturn:  { name: 'í† ì„±', lat: 37.488928, lng: 126.956250, model: './models/saturn_planet.glb', scale: '0.4 0.4 0.4' },
        uranus:   { name: 'ì²œì™•ì„±', lat: 37.4891, lng: 126.9569, model: './models/saturn_planet.glb', scale: '0.4 0.4 0.4' },
        neptune:   { name: 'í•´ì™•ì„±', lat: 37.488615, lng: 126.956499, model: './models/saturn_planet.glb', scale: '0.4 0.4 0.4' },        
    };    
    // testìš©
        const planetData = {
        earth: { name: 'ğŸŒ ì§€êµ¬', video: './mp4/sun.mp4', stamp: './images/earth.png', quizPool: [
            { q: "ì§€êµ¬ì—ì„œ ë¬¼ì´ ì°¨ì§€í•˜ëŠ” ë¹„ìœ¨ì€?", o: ["51%", "61%", "71%", "81%"], a: 2, e: "ì§€êµ¬ í‘œë©´ì˜ ì•½ 71%ê°€ ë°”ë‹¤ë¡œ ì´ë£¨ì–´ì ¸ ìˆìŠµë‹ˆë‹¤." },
            { q: "ì§€êµ¬ì˜ ì˜ì–´ ì´ë¦„ì€ ë¬´ì—‡ì¼ê¹Œìš”?", o: ["Mars", "Venus", "Mercury", "Earth"], a: 4, e: "ì§€êµ¬ì˜ ì˜ì–´ ì´ë¦„ì€ Earth ì…ë‹ˆë‹¤." },
            // ... (3 more questions)
        ]},
        mars: { name: 'ğŸ”´ í™”ì„±', video: './mp4/mercury.mp4', stamp: './images/mars.png', quizPool: [
            { q: "í™”ì„±ì˜ ì˜ì–´ ì´ë¦„ì€ ë¬´ì—‡ì¼ê¹Œìš”?", o: ["Mars", "Venus", "Mercury", "Jupiter"], a: 1, e: "í™”ì„±ì˜ ì˜ì–´ ì´ë¦„ì€ Mars ì…ë‹ˆë‹¤." },
            { q: "í™”ì„±ì´ ë¶‰ì€ìƒ‰ìœ¼ë¡œ ë³´ì´ëŠ” ì´ìœ ëŠ”?", o: ["ìš©ì•” ë•Œë¬¸ì—", "ëŒ€ê¸° ë•Œë¬¸ì—", "ì²  ì‚°í™”ë¬¼ ë•Œë¬¸ì—", "ì–¼ìŒ ë•Œë¬¸ì—"], a: 2, e: "ì‚°í™”ì²  ì„±ë¶„ì´ ëŒ€ê¸° ì¤‘ì— í¼ì ¸ ìˆì–´ ë©€ë¦¬ì„œ í–‰ì„± ì „ì²´ê°€ ë¶‰ì€ìƒ‰ìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤. " },
            // ... (4 more questions)
        ]},
        jupiter: { name: 'ğŸª ëª©ì„±', video: './mp4/venus.mp4', stamp: './images/jupiter.png', quizPool: [
            { q: "ëª©ì„±ì˜ ì˜ì–´ ì´ë¦„ì€ ë¬´ì—‡ì¼ê¹Œìš”?", o: ["Venus", "Saturn", "Mercury", "Jupiter"], a: 4, e: "ëª©ì„±ì˜ ì˜ì–´ ì´ë¦„ì€ Jupiter ì…ë‹ˆë‹¤." }, 
            { q: "ëª©ì„±ì˜ ê°€ì¥ í° íŠ¹ì§•ì€?", o: ["ê°€ì¥ ëœ¨ê±°ì›€", "ê°€ì¥ í¼", "ê°€ì¥ ë¹ ë¦„", "ê°€ì¥ ë°ìŒ"], a: 2, e: "ëª©ì„±ì€ íƒœì–‘ê³„ì—ì„œ ê°€ì¥ í° í–‰ì„±ì…ë‹ˆë‹¤." },  
            // ... (3 more questions)
        ]},
        saturn: { name: 'ğŸ’« í† ì„±', video: '/mp4/saturn.mp4', stamp: './images/saturn.png', quizPool: [
            { q: "í† ì„±ì˜ ì˜ì–´ ì´ë¦„ì€ ë¬´ì—‡ì¼ê¹Œìš”?", o: ["Mars", "Saturn", "Mercury", "Jupiter"], a: 2, e: "í† ì„±ì˜ ì˜ì–´ ì´ë¦„ì€ Saturn ì…ë‹ˆë‹¤." }, 
            { q: "í† ì„±ì˜ ê°€ì¥ ìœ ëª…í•œ íŠ¹ì§•ì€?", o: ["ê±°ëŒ€í•œ í­í’", "ì•„ë¦„ë‹¤ìš´ ê³ ë¦¬", "ê°€ì¥ ë§ì€ ë‹¬", "ê°€ì¥ ë¹ ë¥¸ ìì „"], a: 2, e: "í† ì„±ì€ ì•„ë¦„ë‹¤ìš´ ì–¼ìŒê³¼ ì•”ì„ ê³ ë¦¬ë¡œ ìœ ëª…í•©ë‹ˆë‹¤."  },           
            // ... (3 more questions)
        ]}, 
        uranus: { name: 'ğŸ’ ì²œì™•ì„±', video: '/mp4/mars.mp4', stamp: './images/uranus.png', quizPool: [
            { q: "ì²œì™•ì„±ì˜ ì˜ì–´ ì´ë¦„ì€ ë¬´ì—‡ì¼ê¹Œìš”?", o: ["Mars", "Venus", "Uranus", "Jupiter"], a: 3, e: "ì²œì™•ì„±ì˜ ì˜ì–´ ì´ë¦„ì€ Uranus ì…ë‹ˆë‹¤."  },
            { q: "ì²œì™•ì„±ë§Œì˜ ë…íŠ¹í•œ íŠ¹ì§•ì€?", o: ["ê°€ì¥ ì°¨ê°€ì›€", "ì˜†ìœ¼ë¡œ ëˆ„ì›Œì„œ ë”", "ê°€ì¥ ì‘ìŒ", "ê°€ì¥ ë¹ ë¦„"], a: 2, e: "ì²œì™•ì„±ì€ 98ë„ ê¸°ìš¸ì–´ì ¸ ìˆì–´ ì˜†ìœ¼ë¡œ ëˆ„ì›Œì„œ ë„ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì…ë‹ˆë‹¤." },
            // ... (3 more questions)
        ]},    
        neptune: { name: 'ğŸŒŠ í•´ì™•ì„±', video: '/mp4/jupiter.mp4', stamp: './images/neptue.png', quizPool: [
            { q: "í•´ì™•ì„±ì˜ ì˜ì–´ ì´ë¦„ì€ ë¬´ì—‡ì¼ê¹Œìš”?", o: ["Mars", "Neptune", "Mercury", "Jupiter"], a: 2, e: "í•´ì™•ì„±ì˜ ì˜ì–´ ì´ë¦„ì€ Neptune ì…ë‹ˆë‹¤."  },
            { q: "í•´ì™•ì„±ì— ëŒ€í•œ ì„¤ëª…ìœ¼ë¡œ ë§ëŠ” ê²ƒì€?", o: ["íƒœì–‘ì— ê°€ì¥ ê°€ê¹Œì›€", "ê°€ì¥ ê°•í•œ ë°”ëŒ", "ê°€ì¥ ë°ìŒ", "ê³ ë¦¬ê°€ ì—†ìŒ"], a: 2, e: "í•´ì™•ì„±ì€ íƒœì–‘ê³„ì—ì„œ ê°€ì¥ ê°•í•œ ë°”ëŒì´ ë¶€ëŠ” í–‰ì„±ì…ë‹ˆë‹¤."  },
            // ... (3 more questions)
        ]},    
    };

    // --- 2. ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
    const planetTitle = document.getElementById('planet-title');
//    const videoContainer = document.getElementById('video-container');
//    const videoPlayer = document.getElementById('video-player');
    const quizContainer = document.getElementById('quiz-container');
    const questionEl = document.getElementById('question');
    const optionsEl = document.getElementById('options');
    const stampCardEl = document.getElementById('stamp-card');
    const resultContainer = document.getElementById('result-container');
    const resultMessage = document.getElementById('result-message');
    const mapBtn = document.getElementById('map-btn');
    const photoBtn = document.getElementById('photo-btn');
    const PlanetCount = Object.keys(planetData).length;
    const StampCard = document.getElementById('stamp-card-container');
    
    let currentPlanetId;
    let currentQuiz;
    let currentPlanet;

    // --- 3. í˜ì´ì§€ ì´ˆê¸°í™” ---
    function initPage() {
        const urlParams = new URLSearchParams(window.location.search);
        currentPlanetId = urlParams.get('planet');   
        const currentPos = planetPos[currentPlanetId];
        const currentJoa = joayongPos[currentPlanetId];
     
        currentPlanet = planetData[currentPlanetId];        

        if (!currentPlanet) {
            alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
            window.location.href = './joayong-map.html';
            return;
        }

        // ìŠ¤íƒ¬í”„ ì¹´ë“œ ë Œë”ë§

        if (currentPos) {
        //    planetModel.setAttribute('gps-entity-place', `latitude: ${currentPos.lat}; longitude: ${currentPos.lng};`);
            planetModel.setAttribute('gltf-model', `url(${currentPos.model})`);
            planetModel.setAttribute('scale', currentPos.scale);      
            joayongModel.setAttribute('gltf-model', `url(${currentJoa.model})`);
            joayongModel.setAttribute('scale', currentJoa.scale);      
        } else {
            alert("í–‰ì„± ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.");
            window.location.href = 'joayong-map.html';
        }

    sceneEl.addEventListener('loaded', () => {
        // 'mousedown' (PC í´ë¦­)ê³¼ 'touchstart' (ëª¨ë°”ì¼ í„°ì¹˜) ì´ë²¤íŠ¸ë¥¼ ê°ì§€í•©ë‹ˆë‹¤.
        // { passive: false } ì˜µì…˜ì„ ì—¬ê¸°ì„œ ì§ì ‘ ì„¤ì •í•©ë‹ˆë‹¤.
        sceneEl.canvas.addEventListener('mousedown', onSceneClick, { passive: false });
        sceneEl.canvas.addEventListener('touchstart', onSceneClick, { passive: false });
    });

        // âœ¨ 3. í´ë¦­/í„°ì¹˜ ì‹œ ì‹¤í–‰ë  ìƒˆë¡œìš´ í•¨ìˆ˜
    function onSceneClick(event) {
        // A-Frame ì”¬ì˜ 3D ê°ì²´ë“¤ê³¼ ì¶©ëŒí•˜ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•œ ê´‘ì„ (ray)ì„ ìƒì„±í•©ë‹ˆë‹¤.
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // í´ë¦­í•œ í™”ë©´ ì¢Œí‘œë¥¼ 3D ê³µê°„ ì¢Œí‘œë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
        if (event.type === 'touchstart') {
            mouse.x = (event.touches[0].clientX / window.innerWidth) * 2 - 1;
            mouse.y = - (event.touches[0].clientY / window.innerHeight) * 2 + 1;
        } else {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
        }

        // ì¹´ë©”ë¼ ìœ„ì¹˜ì—ì„œ í´ë¦­í•œ ë°©í–¥ìœ¼ë¡œ ê´‘ì„ ì„ ì©ë‹ˆë‹¤.
        raycaster.setFromCamera(mouse, sceneEl.camera);
        
        // ê´‘ì„ ì´ 3D ëª¨ë¸(planetModelEntity)ê³¼ ì¶©ëŒí–ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
        const intersects = raycaster.intersectObject(joayongModel.object3D, true);

        if (intersects.length > 0) {
            // ì¶©ëŒí–ˆë‹¤ë©´ (ì¦‰, ì‚¬ìš©ìê°€ 3D ëª¨ë¸ì„ í´ë¦­í–ˆë‹¤ë©´)
            console.log(`${currentPlanet.name} íšë“!`);
            
            // ê¸°ë³¸ ë¸Œë¼ìš°ì € ë™ì‘(ìŠ¤í¬ë¡¤ ë“±)ì„ ë§‰ìŠµë‹ˆë‹¤.
            event.preventDefault();
            
            sceneEl.classList.add('hidden');
            InfoView.style.display='none';
//            videoQuizView.classList.remove('hidden');
            startVideoAndQuiz(currentPlanetId);
        }
    }

  }
    // --- 4. í€´ì¦ˆ í‘œì‹œ ---
    function showQuiz() {
  //      videoContainer.classList.add('hidden');
        PlanetInfo = document.getElementById('Planet-Info');
        
        quizContainer.classList.remove('hidden');    
        
        const img = new Image();
        img.src = currentPlanet.stamp;
        img.style.objectFit = 'cover';
        img.style.height= '100%';
        img.style.width= '100%';

        PlanetInfo.appendChild(img);

        const span = document.createElement('span');
        span.innerText = currentPlanet.name;
        spanElement.setAttribute('style', 'display: inline-block; padding: 4px 12px; font-size: 12px; font-weight: 500; border-radius: 20px; margin-bottom: 16px; background-color: #2563eb; color: white; text-align: center;');
        PlanetInfo.appendChild(span);
        
  //      const currentPlanet = planetData[currentPlanetId];
        // 5ë¬¸ì œ ì¤‘ ëœë¤ìœ¼ë¡œ í•˜ë‚˜ ì„ íƒ
        currentQuiz = currentPlanet.quizPool[Math.floor(Math.random() * currentPlanet.quizPool.length)];    
        questionEl.textContent = currentQuiz.q;
        optionsEl.innerHTML = '';
        
        currentQuiz.o.forEach((optionText, index) => {
            const button = document.createElement('button');
            button.textContent = optionText;
            button.onclick = () => checkAnswer(index + 1);
            optionsEl.appendChild(button);
        });
    }
    // --- 5. ì •ë‹µ í™•ì¸ ë° ìŠ¤íƒ¬í”„ íšë“ ---
    async function checkAnswer(selectedIndex) {
        quizContainer.classList.add('hidden');

        if (selectedIndex === currentQuiz.a) {
            const collectedStamps = JSON.parse(localStorage.getItem('stamps')) || {};
            collectedStamps[currentPlanetId] = true;
            localStorage.setItem('stamps', JSON.stringify(collectedStamps));
            
            try {
                await fetch('/api/collect-stamp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: localStorage.getItem('userId'), planetId: currentPlanetId })
                });
            } catch (error) {
                console.error("ì„œë²„ì— ìŠ¤íƒ¬í”„ë¥¼ ê¸°ë¡í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:", error);
            }

            resultMessage.textContent = "ì •ë‹µì…ë‹ˆë‹¤! âœ¨ ìŠ¤íƒ¬í”„ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!";
            // 2. ìŠ¤íƒ¬í”„ ì¹´ë“œ UIë¥¼ ì¦‰ì‹œ ê°±ì‹ í•©ë‹ˆë‹¤.
            renderStampCard();
            StampCard.classList.remove('hidden');

            // 10ê°œ ëª¨ë‘ ëª¨ì•˜ëŠ”ì§€ í™•ì¸
            const PlaneLength = Object.keys(planetData).length;
            const totalStamps = Object.keys(collectedStamps).length;
            if (totalStamps >= PlaneLength) {
                alert("ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  í–‰ì„± ìŠ¤íƒ¬í”„ë¥¼ ëª¨ì•˜ìŠµë‹ˆë‹¤. ê²½í’ˆ ë£°ë › í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤!");
                mapBtn.textContent = "ğŸ QRì½”ë“œ ì°ê¸°";
                mapBtn.onclick = () => { window.location.href = 'scanner.html'; };
                photoBtn.classList.add('hidden');
                resultContainer.classList.remove('hidden'); 
                return;
            }
        } else {
            resultMessage.textContent = "ì•„ì‰¬ì›Œìš”, ì •ë‹µì´ ì•„ë‹™ë‹ˆë‹¤. ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!";
            quizContainer.classList.add('hidden');
            resultContainer.classList.remove('hidden');
            // ì˜¤ë‹µ ì‹œì—ëŠ” 2ì´ˆ í›„ ë‹¤ì‹œ í€´ì¦ˆ í™”ë©´ìœ¼ë¡œ
            setTimeout(() => {
                resultContainer.classList.add('hidden');
                showQuiz();
                return; // ì•„ë˜ resultContainerë¥¼ ë‹¤ì‹œ ë³´ì´ê²Œ í•˜ëŠ” ì½”ë“œë¥¼ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
            }, 2000);
        }
        resultContainer.classList.remove('hidden');
    }
    
    // --- 6. ìŠ¤íƒ¬í”„ ì¹´ë“œ ë Œë”ë§ ---
    function renderStampCard() {
        stampCardEl.innerHTML = '';
        const collectedStamps = JSON.parse(localStorage.getItem('stamps')) || {};

        Object.keys(planetData).forEach(planetId => {
            const planet = planetData[planetId];
            const slot = document.createElement('div');
            slot.className = 'stamp-slot';
            
            const img = document.createElement('img');
            img.src = planet.stamp;

            const name = document.createElement('div');
            name.className = 'planet-name';
            name.textContent = planet.name.split(' ')[1]; // ì´ëª¨ì§€ ì œì™¸í•˜ê³  ì´ë¦„ë§Œ í‘œì‹œ

            if (collectedStamps[planetId]) {
                slot.classList.add('stamped');
            }
            
            slot.appendChild(img);
            slot.appendChild(name);
            stampCardEl.appendChild(slot);
        });
    }

    // --- 7. ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ---
    mapBtn.onclick = () => { window.location.href = './joayong-map.html'; };
    photoBtn.onclick = () => { window.location.href = `photozone.html?planet=${currentPlanetId}`; };

       // --- 3. ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ì—°ê²°í•©ë‹ˆë‹¤. ---
    
    function startVideoAndQuiz(planetId) {
//        console.log(`${planetId}ì˜ ë¹„ë””ì˜¤ì™€ í€´ì¦ˆë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.`);
        planetTitle.textContent = `${currentPlanet.name} í€´ì¦ˆ`;
        renderStampCard();

        // ì´ë¯¸ íšë“í•œ ìŠ¤íƒ¬í”„ì¸ì§€ í™•ì¸
        const collectedStamps = JSON.parse(localStorage.getItem('stamps')) || {};
        const userId = localStorage.getItem('userId');  

   //     if (Object.keys(collectedStamps).length >= PlanetCount) {
        // âœ¨ 1. ê°€ì¥ ë¨¼ì € ì „ì²´ ìŠ¤íƒ¬í”„ ê°œìˆ˜ë¶€í„° í™•ì¸í•©ë‹ˆë‹¤.
    
        fetch(`/api/check-eligibility/${userId}`)
            .then(res => res.json())
            .then(status => {
                console.log("ì„œë²„ ì‘ë‹µ (ê²½í’ˆ ìˆ˜ë ¹ ì—¬ë¶€):", status.hasRedeemed);
                console.log("í˜„ì¬ ë¡œì»¬ ìŠ¤íƒ¬í”„ ê°œìˆ˜:", Object.keys(collectedStamps).length);

            if (status.hasRedeemed) {
                // 1. ìµœì¢… ê²½í’ˆê¹Œì§€ ë°›ì€ ìœ ì €
    //            videoContainer.classList.add('hidden');
                quizContainer.classList.add('hidden');
                resultMessage.textContent = "ëª¨ë“  ì´ë²¤íŠ¸ì— ì°¸ì—¬í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! ê²½í’ˆì„ ì´ë¯¸ ìˆ˜ë ¹í•˜ì…¨ìŠµë‹ˆë‹¤.";
                mapBtn.textContent = "ğŸ—ºï¸ ë©”ì¸ ì§€ë„ë¡œ";
                mapBtn.onclick = () => { window.location.href = 'joayong-map.html'; };
                photoBtn.classList.add('hidden');
                resultContainer.classList.remove('hidden');
                return; // ì—¬ê¸°ì„œ ë¡œì§ ì¢…ë£Œ
            } 
            
            else if (Object.keys(collectedStamps).length >= PlanetCount) {
                // 2. ìŠ¤íƒ¬í”„ëŠ” ë‹¤ ëª¨ì•˜ì§€ë§Œ ì•„ì§ QRì„ ì•ˆ ì°ì€ ìœ ì €
    //            videoContainer.classList.add('hidden');
                quizContainer.classList.add('hidden');                
                resultMessage.textContent = "ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  ìŠ¤íƒ¬í”„ë¥¼ ëª¨ì•˜ìŠµë‹ˆë‹¤. ë¶€ìŠ¤ì—ì„œ QRì½”ë“œë¥¼ ì°ì–´ ê²½í’ˆì„ ë°›ìœ¼ì„¸ìš”!";
                mapBtn.textContent = "ğŸ QRì½”ë“œ ì°ê¸°";
                mapBtn.onclick = () => { window.location.href = './scanner.html'; };
                photoBtn.classList.add('hidden');
                resultContainer.classList.remove('hidden'); 
                return; // ì—¬ê¸°ì„œ ë¡œì§ ì¢…ë£Œ
            }             
            
            else if (collectedStamps[currentPlanetId]) {
                // 3. í˜„ì¬ ìŠ¤íƒ¬í”„ë§Œ ì´ë¯¸ íšë“í•œ ìœ ì €
    //            videoContainer.classList.add('hidden');
                quizContainer.classList.add('hidden');
                resultMessage.textContent = "ì´ë¯¸ ì´ í–‰ì„±ì˜ ìŠ¤íƒ¬í”„ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!";
                resultContainer.classList.remove('hidden'); 
                return; // ì—¬ê¸°ì„œ ë¡œì§ ì¢…ë£Œ
            } 
            
            else {
            // 4. ìƒˆë¡œìš´ ìŠ¤íƒ¬í”„ì— ë„ì „í•˜ëŠ” ìœ ì €
    //            videoContainer.classList.remove('hidden');
                quizContainer.classList.remove('hidden');
                resultContainer.classList.add('hidden');
    //            videoPlayer.src = currentPlanet.video;
    //            videoPlayer.onended = showQuiz;
                showQuiz();
            }
            
        })
    
        .catch(err => {
            console.error("ìê²© í™•ì¸ API í˜¸ì¶œ ì˜¤ë¥˜:", err);
            alert("ì‚¬ìš©ì ì •ë³´ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    }


    // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œì‘ ---
    initPage();
});
</script>

</body>
</html>